---
title : "source"
output : html_document
---

# source.Rmd
#
# William John Zywiec
# The George Washington University

```{r}

# initialize environment
if (!is.null(dev.list())) dev.off()
rm(list = ls())
cat("\014")

```

```{r setup, include = FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# load packages
library(magrittr)

# set variables
dist <- "weibull"
ensemble.size <- 20
replot <- FALSE

source.dir <- "E:/Dropbox/GWU/R/main"
test.dir <- "E:/test-sph-19mar20"

```

```{r}

# load function
source(paste0(source.dir, "/tabulate.R"))

setwd(test.dir)

# tabulate data
data.set <- Tabulate(source.dir)

```

```{r}

# load function
source(paste0(source.dir, "/bn.R"))

setwd("E:/dist")

# build Bayesian network
bn <- BN(dist)

```

```{r}

source(paste0(source.dir, "/nn.R"))

setwd(test.dir)

# build ensemble model
ensemble.model <- NN(data.set, ensemble.size, replot, source.dir, test.dir)

```

```{r}

# set variables
risk.pool <- 100
sample.size <- 1e+07

# load function
source(paste0(source.dir, "/risk.R"))

setwd(test.dir)

# estimate risk
if (sample.size >= 1e+09) {
  risk.pool <- risk.pool * sample.size / 1e+08
  sample.size <- 1e+08
}

bn.data <- list()
risk <- numeric()

for (i in 1:risk.pool) {
  bn.data[[i]] <- Risk(bn, data.set, ensemble.model, ensemble.size, sample.size)
  risk[i] <- length(bn.data[[i]]$keff[bn.data[[i]]$keff >= 0.9558]) / sample.size # USL = 0.9558
  if (i == 1) {
    progress.bar <- txtProgressBar(min = 0, max = risk.pool, style = 3)
    setTxtProgressBar(progress.bar, i)
  } else if (i == risk.pool) {
    setTxtProgressBar(progress.bar, i)
    cat("\n", sep = "")
  } else {
    setTxtProgressBar(progress.bar, i)
  }
}

cat("\nRisk = ", mean(risk), "\n", sep = "")

risk.dir <- paste0(test.dir, "/", dist)
dir.create(risk.dir, showWarnings = FALSE)
setwd(risk.dir)

risk <- as.data.frame(risk, col.names = "risk") %>% write.csv(paste0("risk.csv"), row.names = FALSE)

saveRDS(bn.data, file = "bn-data.RData")

```
